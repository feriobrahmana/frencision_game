<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Network Propagation Game</title>
  <link rel="stylesheet" href="src/styles.css" />
</head>
<body>
  <aside>
    <h2 style="margin:0 0 8px 0">Rules & Goal</h2>
    <div class="card" style="font-size:14px;line-height:1.4">
      In this little world, new faces drift in and look around. On each step, up to <em>z</em> newcomers arrive, each tagged as <strong>Privileged</strong>, <strong>Stable</strong>, or <strong>Struggling</strong>. Their categories steer who they try to meet, with some chance of stopping early. No one stumbles into <em>you</em> by accident — the only way to connect to you is if you choose them.
      <br><br>
      Every <em>k</em> steps (including the very start), you may invite exactly one person into your circle — either by clicking their node or choosing them from the list. Each invite costs budget, and these are the only edges that ever touch you.
      <br><br>
      Now and then, the world tilts. On a <strong>shock</strong> step (every <em>N</em>), a random source spreads either a <em>positive</em> pulse (+p<sub>s</sub>) to its immediate neighbors or a <em>negative</em> pulse (n<sub>s</sub>) out to two hops — with probability <em>p</em> for the negative case. We highlight who was touched, then pause so you can see the splash.
      <br><br>
      On a <strong>purge</strong> step (every <em>P</em>), we preview all nodes whose score has fallen below <em>D<sub>score</sub></em>. Step again and they’re removed; only then does growth continue. You lose only if <em>you</em> are purged.
      <br><br>
      <strong>Your aim:</strong> make the right friendships to last as long as you can while pushing your score as high as you can.
    </div>

    <div class="card controls">
      <div class="row"><label>Max spawns per step (z)</label><input id="zMax" type="number" min="0" max="10" value="5"></div>
      <div class="row"><label>Edges per new node (e)</label><input id="edgesPerNode" type="number" min="1" max="5" value="2"></div>
      <div class="row"><label>Pick period (k)</label><input id="kPeriod" type="number" min="1" max="20" value="7"></div>
      <div class="row"><label>Shock period (N)</label><input id="nPeriod" type="number" min="2" max="30" value="3"></div>
      <div class="row"><label>Purge period (P)</label><input id="pPeriod" type="number" min="2" max="30" value="10"></div>
      <div class="row"><label>Friend budget (B)</label><input id="friendBudget" type="number" min="0" max="50" value="10"></div>
      <div class="row"><label>Spawn prior — Privileged</label><input id="spawnPriv" type="number" min="0" max="1" step="0.01" value="0.20"></div>
      <div class="row"><label>Spawn prior — Stable</label><input id="spawnStable" type="number" min="0" max="1" step="0.01" value="0.60"></div>
      <div class="row"><label>Spawn prior — Struggling</label><input id="spawnStrug" type="number" min="0" max="1" step="0.01" value="0.20"></div>
      <div class="row" style="font-size:12px;color:var(--muted);justify-content:flex-end">Renormalized to sum to 1.00</div>

      <!-- Shock parameters -->
      <div class="row"><label>Positive shock (p_s)</label><input id="pPosVal" type="number" step="0.1" value="2"></div>
      <div class="row"><label>Negative shock (n_s)</label><input id="nNegVal" type="number" step="0.1" value="-1"></div>
      <div class="row"><label>Pr(negative) p</label><input id="negProb" type="number" min="0" max="1" step="0.05" value="0.80"></div>
      <div class="row"><label>D_score threshold</label><input id="dThreshold" type="number" step="0.1" value="1"></div>

      <div class="row"><label><input id="showLabels" type="checkbox" checked> Show category & score</label></div>
      <div class="row"><label><input id="allowYouSource" type="checkbox"> YOU can be shock source</label></div>

      <div class="row" style="gap:6px;flex-wrap:wrap">
        <button id="btnStart">Start</button>
        <button id="btnStep" class="secondary">Step</button>
        <button id="btnAuto" class="secondary">Auto ▶</button>
        <button id="btnReset" class="danger">Reset</button>
      </div>

      <div class="statline">
        <div class="pill" id="statStep">t = 0</div>
        <div class="pill" id="statNodes">Nodes: 0</div>
        <div class="pill" id="statFriends">Friends: 0 / 0</div>
        <div class="pill" id="statScore">YOU score: 0.0</div>
        <div class="pill" id="statStatus">Status: Ready</div>
      </div>

      <div class="legend">
        <div><span class="dot" style="background:var(--good)"></span> You</div>
        <div><span class="dot" style="background:var(--accent)"></span> Your friends</div>
        <div><span class="dot" style="background:#64748b"></span> Others</div>
        <div><span class="dot" style="background:#64748b;border:2px solid #f59e0b"></span> Privileged ring</div>
        <div><span class="dot" style="background:#64748b;border:2px solid #3b82f6"></span> Stable ring</div>
        <div><span class="dot" style="background:#64748b;border:2px solid #ef4444"></span> Struggling ring</div>
        <div><span class="dot" style="background:var(--danger)"></span> Negative shock (≤2 hops)</div>
        <div><span class="dot" style="background:var(--pos)"></span> Positive shock (≤1 hop)</div>
        <div><span class="dot" style="background:var(--source)"></span> Shock source</div>
        <div><span class="dot" style="background:var(--purge)"></span> Purge preview</div>
      </div>

      <div class="banner" id="pickBanner" style="display:none">Pick phase: choose visually or via list, or press <em>Skip</em>.</div>

      <!-- List-based picker -->
      <div class="pickerRow">
        <select id="selPick" disabled title="Eligible nodes appear here during pick phase"></select>
        <button id="btnPickFromList" class="secondary" disabled>Befriend</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnSkip" class="secondary" style="width:100%">Skip pick</button>
      </div>
    </div>

    <!-- Analytics -->
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <h3 style="margin:0;font-size:15px">Analytics</h3>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button id="btnDownloadCSV" class="secondary">Download CSV</button>
          <button id="btnDownloadCharts" class="secondary">Charts PNG</button>
        </div>
      </div>
      <div class="charts" style="margin-top:8px">
        <div class="chartRow">
          <div class="chartBox">
            <div class="chartTitle">Average Degree</div>
            <canvas id="chartAvgDeg" class="spark"></canvas>
          </div>
          <div class="chartBox">
            <div class="chartTitle">Density</div>
            <canvas id="chartDensity" class="spark"></canvas>
          </div>
        </div>
        <div class="chartRow">
          <div class="chartBox">
            <div class="chartTitle">Global Clustering Coefficient</div>
            <canvas id="chartCluster" class="spark"></canvas>
          </div>
          <div class="chartBox">
            <div class="chartTitle">Degree Gini</div>
            <canvas id="chartGini" class="spark"></canvas>
          </div>
        </div>
        <div class="chartRow">
          <div class="chartBox">
            <div class="chartTitle">Affected (by shock)</div>
            <canvas id="chartAffected" class="spark"></canvas>
          </div>
          <div class="chartBox">
            <div class="chartTitle">Purged</div>
            <canvas id="chartPurged" class="spark"></canvas>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <main>
    <header>
      <h1>Long Friendship — A Network Survival Game</h1>
      <div style="font-size:13px;color:var(--muted)">Last as many steps as you can and grow your utility by choosing the right friends.</div>
    </header>

    <canvas id="canvas"></canvas>

    <div id="statusBar">Status: Ready</div>

    <div class="footer">Vanilla HTML5 Canvas + JS. No libraries.</div>
  </main>

  <script type="module" src="src/app.js"></script>
</body>
</html>
